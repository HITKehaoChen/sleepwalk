<html>
  
<head>
<title>Sleepwalk</title>
</head>

<body>

<table>
  <tr>
    <td><svg id="chart0"></svg></td>
    <td width="60px"></td>
    <td><svg id="chart1"></svg></td>
    <td width="60px"></td>
    <td><svg id="chart2"></svg></td>
  </tr>
  <tr>
    <td><svg id="chart3"></svg></td>
    <td width="60px"></td>
    <td><svg id="chart4"></svg></td>
    <td width="60px"></td>
    <td><svg id="chart5"></svg></td>
  </tr>
  <tr>
    <td><svg id="chart6"></svg></td>
    <td width="60px"></td>
    <td><svg id="chart7"></svg></td>
    <td width="60px"></td>
    <td><svg id="chart8"></svg></td>
  </tr>
</table>

<script src="d3.v5.min.js"></script>

<script>

width = 500

n_charts = 2

deeprange = function(a) {
   var min = Infinity
   var max = -Infinity
   for( var i = 0; i < a.length; i++ ) {
      var x = a[i]
      var r
      if( Array.isArray(x) )
         r = deeprange( x )
      else
         r = [ x, x ]
      if( r[0] < min )
         min = r[0]
      if( r[1] > max )
         max = r[1]
   }
   return [ min, max ]
}

set_up_chart = function() {

   scale = []
   distanceScale = []
   colorScale = []

   make_colorScale = function( distanceScale ) {
      return function( d ) {
         return d3.interpolateCubehelixDefault( distanceScale(d) )
      }      
   }

   for( var ch = 0; ch < n_charts; ch++ ) {

	   scale[ch] = d3.scaleLinear()
	      .domain( deeprange( embedding ) )
	      .range( [ 0, width ] )

	   distanceScale = d3.scaleLinear()
	      .domain( [ 0, maxdist ] )
	      .range( [ 0, .8 ] )
	      .clamp( true )      

	   colorScale[ch] = make_colorScale( distanceScale )
   }

   for( var ch = 0; ch < n_charts; ch++ ) {
	   d3.select( "#chart" + ch )
	      .attr( "width", width )
	      .attr( "height", width )
	      .selectAll("circle")
	      .data( embedding[ch] )
	      .enter().append( "circle" )
	         .attr( "cx", function(d) { return scale[ch]( d[0] ) } )
	         .attr( "cy", function(d) { return scale[ch]( d[1] ) } )
	         .attr( "r", 1.5 )
	         .attr( "stroke", 0 )
	         .attr( "fill", "gray" )

      
      on_mouse_over = ( function(ch) {
         return function( d, i ) { new_center_cell( ch, i )}
      })( ch )
      d3.select( "#chart" + ch )
         .selectAll("circle")
	         .on( "mouseover", on_mouse_over )            
   }
}

new_center_cell = function( chart, cell ) {

   var x_sel_cell = featureMatrix[chart][ cell ]

   for( ch = 0; ch < n_charts; ch++ ) {

      var distCols = Array( embedding[ch].length )
      for( var j = 0; j < distCols.length; j++ ) {
         var s = 0
         for( var i = 0; i < x_sel_cell.length; i++ ) {
            var dd = x_sel_cell[i] - featureMatrix[ch][j][i]
            s += dd * dd
         }
         distCols[j] = colorScale[ch](s)
      }

      d3.select( "#chart" + ch )
         .selectAll("circle")
         .data( distCols )
         .attr( "fill", function( d ) { return d } )

   }
}

</script>
</body>

</html>